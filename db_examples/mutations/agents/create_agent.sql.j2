-- Create Agent Mutation
-- Inserts a new agent, initializes its attributes, and optionally associates it with cultures
-- 
-- Parameters:
--   :name - Agent name (TEXT, required)
--   :memory_size - Memory capacity (INT, must be >= 3)
--   :culture_ids - Array of culture IDs to associate with the agent (INT[], optional)
--   :attribute_values - Attribute values array aligned to defs by col_idx (DOUBLE PRECISION[], required)
--
-- Returns: The newly created agent's ID
--
-- Example usage:
--   INSERT INTO agents (name, memory_size) 
--   VALUES ('Athena', 10);

-- Create the agent, initialize attributes, and optionally associate cultures (CTE)
WITH new_agent AS (
  INSERT INTO agents (name, memory_size)
  VALUES (:name, :memory_size)
  RETURNING id
),
inserted_attrs AS (
  INSERT INTO agent_attributes (agent_id, attribute_values)
  SELECT id, :attribute_values::double precision[] FROM new_agent
),
inserted_cultures AS (
  INSERT INTO agent_cultures (agent_id, culture_id)
  SELECT na.id, cid
  FROM new_agent na
  CROSS JOIN LATERAL unnest(coalesce(:culture_ids::int[], '{}'::int[])) AS cid(cid)
)
SELECT id FROM new_agent;